<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAssembly Test with GC</title>
</head>
<body>
    <h1>WebAssembly Test with GC</h1>
    <div id="output"></div>

    <script>
        const output = document.getElementById('output');
        const tagToImport = new WebAssembly.Tag({ parameters: ["i32", "i64"] });

        // Function to log messages to the page
        function log(message) {
            output.innerHTML += message + '<br>';
        }

        let instance;
        const importObject = {
          m: {
            t: tagToImport,
          },
  "wasi:io/poll@0.2.1": {
    "poll": function() {},
  },
  "wasi:clocks/monotonic-clock@0.2.1": {
    "subscribe-duration": function() {}
  },

          console: { log: (value) => log(`WebAssembly log: ${value}`) },
          "wasi_snapshot_preview1": {
            proc_exit(code) {
              console.log("exit code: ", code);
            },
            fd_write(fd, iovsPtr, iovsLength, bytesWrittenPtr){
    const iovs = new Uint32Array(instance.exports.memory.buffer, iovsPtr, iovsLength * 2);
    if(fd === 1) { //stdout
        let text = "";
        let totalBytesWritten = 0;
        const decoder = new TextDecoder();
        for(let i =0; i < iovsLength * 2; i += 2){
            const offset = iovs[i];
            const length = iovs[i+1];
            const textChunk = decoder.decode(new Int8Array(instance.exports.memory.buffer, offset, length));
            text += textChunk;
            totalBytesWritten += length;
        }
        const dataView = new DataView(instance.exports.memory.buffer);
        dataView.setInt32(bytesWrittenPtr, totalBytesWritten, true);
        console.log(text);
    }
    return 0;
            }}
        };

        (async function() {
        // Load and instantiate the WebAssembly module
        // let response = await fetch('tests/ref-cast.wasm');
        let response = await fetch('wasm/generated.wasm');
        let bytes = await response.arrayBuffer();
        let compiled = await WebAssembly.compile(bytes, { builtins: ['js-string'] });
        instance = await WebAssembly.instantiate(compiled, importObject)
        const exports = instance.exports;
        //     
        // // Call the start function
        console.time('start');
        let result = exports["wasi:cli/run@0.2.1#run"]();
        console.log("result: ", result);
        console.timeEnd('start');

        log("Start function called. Check the WebAssembly log above for the result.");
        // }).catch(error => {
        //   debugger
        //     log('Error: ' + error);
        // });
        })();
    </script>
</body>
</html>
